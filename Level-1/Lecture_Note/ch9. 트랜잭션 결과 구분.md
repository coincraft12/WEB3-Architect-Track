# 9강. 트랜잭션 결과 구분: 성공(Success)·실패(Failure)는 “돈이 갔냐”가 아니라 “상태가 바뀌었냐”다

## 0) 이 강의의 한 문장
**성공/실패는 감정이 아니라 ‘상태(State) 전이의 결과’다.**  
트랜잭션은 실패해도 “아무 일도 없던 것”이 아니라, **의사결정이 제출되었고 실행이 시도되었으며 비용(가스)이 소모되고 기록(영수증/흔적)이 남는 사건**이다.

---

## 1) 강의 목표 (수강생이 끝나고 할 수 있어야 하는 것)
이 강의를 마치면 수강생은:

1. 성공/실패를 “입금 됐냐/안 됐냐”가 아니라 **상태 변화 관점**으로 정의할 수 있다.  
2. 실패가 발생하는 구조적 원인을 6가지로 분류해 설명할 수 있다(서명/검증/실행/권한/조건/환경).  
3. “revert”의 의미와 “실패해도 남는 것(영수증/가스/로그)”을 구분할 수 있다.  
4. 실패 트랜잭션을 온체인 분석에서 왜 중요한 데이터로 보는지 설명할 수 있다.  
5. 다음 강의(가스 조건)로 연결: “실패의 많은 원인은 가스/실행 조건과 연결된다”를 이해한다.

---

## 2) 도입 멘트 (강의 시작 2~3분 대본)
> 대부분의 초급자는 실패 트랜잭션을 이렇게 생각해요.  
> “실패했으면 아무 일도 없던 거 아니야?”  
>  
> 그런데 현실은 반대입니다.  
> 실패는 “아무 일도 없음”이 아니라 **실행이 시도되었고, 그 시도 자체가 비용과 흔적을 남긴 사건**이에요.  
>  
> 오늘은 성공/실패를 구조적으로 구분하고,  
> 실패를 ‘문제’가 아니라 ‘데이터’로 읽는 눈을 만들겠습니다.

---

## 3) 핵심 정의: 성공/실패는 “상태 변화의 승인 여부”
### 3.1 성공(Success)
- 네트워크 검증을 통과했고
- 실행이 완료되어
- 의도된(또는 규칙에 따른) 상태 변화가 반영되었다

### 3.2 실패(Failure)
실패는 크게 두 계층이 있다(초급에서 가장 중요한 구분).

- **(A) 포함되기 전 실패(Pre-inclusion failure)**  
  - 트랜잭션이 블록에 포함되기 전에 거부/무효 처리
  - 예: 서명 불일치, nonce 문제로 전파만 되다 사라짐, 기본 조건 위반

- **(B) 포함된 후 실패(On-chain failure / Revert)**  
  - 블록에 포함되었고 실행이 시도되었으나,
  - 실행 중 조건 위반/권한 부족/로직 오류 등으로 revert 되어
  - 핵심 상태 변화가 반영되지 않았다(또는 제한적으로만 반영)

**암기 문장**
- “실패”에는 **블록에 들어가기 전에 실패**와 **들어간 다음 실패(revert)** 가 있다.

---

## 4) “revert”를 초급 언어로 다시 정의하기
revert는 한 문장으로:
- **“실행 도중 ‘조건이 안 맞아서’ 상태 변경을 되돌리고 멈춘 것”** 이다.

여기서 오해 방지:
- revert가 나면 “상태 변화가 0”이라고 생각하기 쉬운데,
  - 보통 핵심 상태는 되돌지만,
  - 실행 시도 자체는 발생했고
  - 가스는 소비되며
  - 영수증(receipt)은 남는다.

**설계자 포인트**
- revert는 “돈이 안 갔다”가 아니라,  
  “그 행동이 승인되지 않았다(규칙에 의해 기각됐다)”에 가깝다.

---

## 5) 실패해도 남는 것 4가지(초급에서 반드시)
실패 트랜잭션에서 남는 흔적:

1) **가스 소비(비용)**
- 실행을 시도한 만큼 자원이 소모된다  
- 실패가 “무료”가 아니다

2) **영수증(Receipt)**
- status(성공/실패), gasUsed, (가능하면) revert reason 등

3) **실행 흔적(Trace) / 내부 호출 흔적(환경에 따라)**
- 일부 탐색기나 분석 도구에서 볼 수 있다

4) **의도(Intent)**
- “누가 무엇을 하려 했는가”가 드러난다  
- 온체인 분석에서 이게 매우 강력한 단서가 된다

---

## 6) 실패 원인의 구조적 분류 6종(“왜 실패했는지”를 계층으로 읽기)
### 6.1 서명/키 계층 실패
- 서명이 유효하지 않음
- 잘못된 체인/네트워크(체인ID)에서 만든 트랜잭션
- 키 통제권 문제(지갑 설정 오류 등)

### 6.2 검증(Validation) 계층 실패
- nonce 불일치(순서 꼬임)
- 잔액 부족(가스/전송값 포함)
- 기본 규칙 위반(형식 오류 등)

### 6.3 합의/환경 계층 실패(“내가 잘못한 게 아닐 수도”)
- 네트워크 혼잡으로 오랫동안 미포함(pending)
- 수수료 조건이 낮아 선택되지 않음
- 재정렬(reorg) 등으로 상태가 바뀌어 조건이 달라짐

### 6.4 실행(Execution) 계층 실패: revert
- require 조건 불충족(슬리피지, 기한, 최소 수량 등)
- 컨트랙트 로직이 특정 상태에서 거부
- 외부 호출 실패(다른 컨트랙트/토큰이 거부)

### 6.5 권한(Approval/Permission) 계층 실패
- approve(allowance) 부족
- 역할 기반 권한(role) 없음
- 소유자만 실행 가능(onlyOwner 등)

### 6.6 사용자 입력/UX 계층 실패
- 잘못된 주소/컨트랙트 선택
- 잘못된 함수 호출
- 파라미터(금액, 슬리피지, deadline) 오입력

**설계자 포인트**
- 실패를 “한 가지 이유”로 보지 말고,  
  **어느 계층에서 실패했는지**로 먼저 분류해야 한다.

---

## 7) “성공인데 손해” vs “실패인데 의미 있음”
초급이 가장 많이 헷갈리는 비교.

### 7.1 성공인데 손해일 수 있다
- 잘못된 주소로 송금 성공(되돌릴 수 없음)
- 스캠 컨트랙트에 승인 성공(권한이 넘어감)
- 나쁜 조건으로 스왑 성공(슬리피지 과다)

### 7.2 실패인데 의미가 크다
- 실패는 “방어선이 작동했다”는 뜻일 수 있다
- 실패 트랜잭션은 공격/탐색/봇 활동의 흔적일 수 있다
- 특정 지갑이 어떤 전략을 시도했는지 드러낸다(의도 데이터)

---

## 8) 온체인 분석 관점: 실패는 “전략의 그림자”다
실패 트랜잭션이 왜 분석에 중요하냐면:

- 사람/봇은 성공 전에 여러 번 시도한다(탐색)  
- 슬리피지/가격/유동성 조건을 맞추려다 실패가 찍힌다  
- 취약점 공격은 여러 번의 실패 후 성공으로 이어질 수 있다  
- 즉, 실패는 “사전 징후”가 된다

**암기 문장**
- 성공은 결과, 실패는 과정이다.  
- 과정은 전략을 보여준다.

---

## 9) 칠판/슬라이드 구성(추천)
### 슬라이드 1: 성공/실패의 정의(상태 변화 관점)
- Success = 상태 전이 완료  
- Failure = 상태 전이 기각(전/후 실패로 분기)

### 슬라이드 2: 실패 계층 6종 피라미드
- UX → 권한 → 실행 → 환경 → 검증 → 서명/키

### 슬라이드 3: “실패해도 남는 것 4가지”
- gas / receipt / trace / intent

---

## 10) 미니 케이스(강의 중 10~15분)
### 케이스: “스왑이 계속 실패(revert)한다”
가능한 구조적 원인(레이어별 질문):
- (입력/UX) 슬리피지 너무 낮게 설정했나? deadline이 지났나?  
- (권한) 토큰 approve가 부족하나?  
- (실행) 풀 유동성이 부족해 최소수량 조건을 만족 못 하나?  
- (환경) 블록 사이에 가격이 움직여 조건이 깨지나? (MEV/변동성)

핵심:
- “왜 실패했지?”를 “어느 계층의 조건이 깨졌지?”로 바꿔서 추적한다.

---

## 11) 미니 실습(20~25분) — 실패 트랜잭션 ‘해부’ 카드 만들기
### 실습 주제: 실패 트랜잭션 1개를 골라 구조적으로 해부
(익스플로러 기준, 가능한 범위에서)

1) 실패 유형: Pre-inclusion vs On-chain revert 중 어디인가?  
2) status / gasUsed 확인  
3) (가능하면) revert reason 확인  
4) 입력(Action): to/data/value가 무엇이었나?  
5) 실패 계층 추정: 6종 분류 중 어디가 가장 유력한가? 근거 2개  
6) 대응: 같은 행동을 다시 하려면 무엇을 바꿔야 하나? 3가지

**출력(산출물)**: “실패 트랜잭션 해부 카드 1장”

---

## 12) 과제
### 과제 1: 실패 원인 분류 연습(1페이지)
실패 트랜잭션 3개를 골라 각각에 대해:
- 실패 유형(전/후)  
- 실패 계층(6종 중 1개 선택)  
- 근거 2개  
- 개선/대응 1개

### 과제 2(선택): “실패는 데이터” 에세이(10문장)
- 실패가 전략과 의도를 보여주는 이유  
- 실패 데이터를 어떤 대시보드/알림으로 활용할 수 있을지 아이디어

---

## 13) 강의 마무리 30초 대본
> 오늘은 성공/실패를 ‘입금 여부’가 아니라 ‘상태 변화’로 재정의했습니다.  
> 실패는 공짜가 아니고, 영수증과 비용과 의도를 남깁니다.  
> 그래서 실패는 문제이기도 하지만, 분석가에게는 강력한 데이터입니다.  
>  
> 다음 강의에서는 실패의 핵심 원인 중 하나인 **가스**를,  
> “수수료”가 아니라 “실행 조건 모델”로 정리하겠습니다.

---

## 14) 퀴즈(12문항, 복습용)
1) 성공/실패를 상태 변화 관점에서 정의하라.  
2) 실패의 두 계층(Pre-inclusion / On-chain revert)을 설명하라.  
3) revert란 무엇인가?  
4) 실패 트랜잭션에서 남는 것 4가지를 쓰시오.  
5) 실패 원인 분류 6종을 쓰시오.  
6) nonce 문제는 어떤 계층의 실패인가?  
7) approve 부족은 어떤 계층의 실패인가?  
8) 네트워크 혼잡으로 pending은 어떤 계층의 문제인가?  
9) 실패가 온체인 분석에 중요한 이유를 한 문장으로 써라.  
10) “성공인데 손해” 예시 1개를 설명하라.  
11) “실패인데 의미 있음” 예시 1개를 설명하라.  
12) 실패 트랜잭션 해부 카드에서 반드시 봐야 할 항목 3개는 무엇인가?

---

## 15) (집필 확장용) 이 강의를 책으로 옮기면 이렇게 된다
- 1. 성공/실패는 돈이 아니라 상태다  
- 2. 실패의 두 계층: 포함 전 vs 포함 후(revert)  
- 3. revert의 의미와 남는 흔적(영수증/가스/의도)  
- 4. 실패 원인 6계층 분류법  
- 5. 성공인데 손해, 실패인데 의미 있는 구조  
- 6. 실패 데이터로 전략 읽기(온체인 분석 시각)  
- 7. 실습: 실패 트랜잭션 해부 카드  
- 8. 다음 장 예고: 가스는 비용이 아니라 실행 조건이다
